<script>
past_url = 'null';
current_url = 'null';
favorited = null;

var LEFT_KEY = 37;
var UP_KEY = 38;
var RIGHT_KEY = 39;
var loggedIn = true;
<% if session[:user_id] == nil %>
  loggedIn = false;
<%end%>



function submitVote(input) {
  $("#loader").show();
  console.log("vote submitted")
  var payload = {'past_url':past_url, 'current_url':current_url, 'vote':input}
  jQuery.ajax({
      url: "/gif_entries/fetchEntry/",
      data: payload,
      success: function(result) {
        $("#loader").hide();
        var parsedResult = JSON.parse(result.toString());
        past_url = current_url;
        current_url = parsedResult.url;
        var score = parsedResult.score;
			  document.getElementById("image").innerHTML = '<img src="' + current_url + '"/>' + '<br>';
        document.getElementById("score").innerHTML = "score: " + score;
        if(parsedResult.favorited == true) {
          document.getElementById("favoriteButton").innerHTML = "Already Favorited";
          favorited = true;
        } else {
          document.getElementById("favoriteButton").innerHTML = "Favorite";
          favorited = false;
        }
        if(input != 0)//would clean any messages on first load of showImage(would clear login messages)
          displayMessage(null);//clears any existing messages
 			 },
  		error: function() {
        $("#loader").hide();
        displayMessage("An error ocurred");
 			 }

  });
}
function submitFavorite(){
  if(!loggedIn) {
    displayMessage("You need to be logged in to add a favorite");
    return;
  }
  if(!favorited) {
    jQuery.ajax({
      url: "/users/addFavorite/",
      data: {'url':current_url},
      success: function(result) {
        displayMessage("Favorited");
        favorited = true;
        document.getElementById("favoriteButton").innerHTML = "Already Favorited";
      },
      error: function() {
        displayMessage("An error ocurred");
      }

    });
  } else
    displayMessage("Gif has already been favorited")
}

$(document).keydown(function(e) {
  switch(e.keyCode) {
    case LEFT_KEY:
      submitVote(-1);
      break;
    case UP_KEY:
      submitFavorite();
      break;
    case RIGHT_KEY:
      submitVote(1);
      break;
    }
    return;
  }
);


$(document).ready(submitVote(0));
$(document).on('page:load', submitVote(0));
</script>

<html>

<%= render '/layouts/ribbon' %>
<div class="showImage" align="center">
  <div class="overlay loader" id="loader">
    <%= image_tag "loader.gif" %>
  </div>
  <div align="center" id="image"><b></div>

</div>
<div align="center">
  <% if session[:user_id] != nil %>
    <div align="center">
      <%= render inline:  '<button id="favoriteButton" onClick="submitFavorite()">Fav</button><b>'.html_safe%> 
    </div>
  <% end %>
  <button id="voteButton" onclick="submitVote(-1)">-</button>
  <button id="voteButton" onclick="submitVote(1)">+</button><b>
  <div align="center" id="score"><b></div>
</div>
</body>
</html>